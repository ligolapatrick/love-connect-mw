<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Messages</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root {
    --bg: #f0f2f5;
    --card: #ffffff;
    --me: #1877f2;
    --them: #e4e6eb;
    --text-on-me: #fff;
    --text-on-them: #050505;
  }
  body { margin:0; font-family: Arial, sans-serif; background: var(--bg); height:100vh; display:flex; flex-direction:column; }
  .header { background: var(--card); padding: 12px 16px; display:flex; align-items:center; gap:10px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
  .header img { width:36px; height:36px; border-radius:50%; object-fit:cover; }
  .header .name { font-weight: bold; }
  .chat { flex:1; overflow-y:auto; padding: 12px; display:flex; flex-direction:column; gap:10px; }
  .row { display:flex; }
  .row.me { justify-content: flex-end; }
  .row.them { justify-content: flex-start; }
  .bubble {
    max-width: 75%;
    padding: 10px 12px;
    border-radius: 18px;
    word-wrap: break-word;
    line-height: 1.3;
    position: relative;
  }
  .me .bubble {
    background: var(--me);
    color: var(--text-on-me);
    border-bottom-right-radius: 6px;
  }
  .them .bubble {
    background: var(--them);
    color: var(--text-on-them);
    border-bottom-left-radius: 6px;
  }
  .time {
    display:block;
    margin-top: 4px;
    font-size: 11px;
    opacity: 0.8;
  }
  .composer {
    background: var(--card);
    padding: 10px;
    display:flex;
    gap:8px;
    align-items:center;
    box-shadow: 0 -2px 4px rgba(0,0,0,0.06);
  }
  .composer input {
    flex:1; padding:10px; border-radius: 20px; border:1px solid #ddd; outline:none;
    background:#fff;
  }
  .composer button {
    background: var(--me); color:#fff; border:none; border-radius: 20px; padding: 10px 14px; cursor:pointer;
  }
</style>
</head>
<body>

<div class="header">
  <img id="peerPic" src="default-avatar.png" alt="User">
  <div>
    <div class="name" id="peerName">Chat</div>
    <div id="peerMeta" style="font-size:12px;color:#65676b;"></div>
  </div>
</div>

<div id="chat" class="chat"></div>

<form id="composer" class="composer">
  <input type="text" id="messageInput" placeholder="Write a message..." autocomplete="off" required />
  <button type="submit"><i class="fa-solid fa-paper-plane"></i></button>
</form>

<script>
  const qs = new URLSearchParams(location.search);
  const peerId = parseInt(qs.get('userId'), 10);
  let meId = null;

  const chatEl = document.getElementById('chat');
  const inputEl = document.getElementById('messageInput');
  const formEl = document.getElementById('composer');
  const peerNameEl = document.getElementById('peerName');
  const peerMetaEl = document.getElementById('peerMeta');
  const peerPicEl = document.getElementById('peerPic');

  function fmtTime(ts) {
    const d = new Date(ts);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function appendMessage(m) {
    const row = document.createElement('div');
    const isMe = m.fromUserId === meId || m.senderId === meId;
    row.className = 'row ' + (isMe ? 'me' : 'them');
    row.innerHTML = `
      <div class="bubble">
        <div>${m.content}</div>
        <span class="time">${fmtTime(m.timestamp || m.createdAt || Date.now())}</span>
      </div>
    `;
    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  async function loadMe() {
    // assuming /api/me exists
    const res = await fetch('/api/me');
    if (!res.ok) { alert('Please login'); location.href = 'login.html'; return; }
    const me = await res.json();
    meId = me.id;
  }

  async function loadPeer() {
    const res = await fetch('/api/user/' + peerId);
    if (res.ok) {
      const u = await res.json();
      peerNameEl.textContent = u.username || 'Chat';
      peerMetaEl.textContent = u.region || '';
      if (u.profilePicture || u.profilePic) peerPicEl.src = u.profilePicture || u.profilePic;
    }
  }

  async function loadHistory() {
    const res = await fetch('/api/messages?chatUserId=' + peerId);
    if (res.ok) {
      const msgs = await res.json();
      msgs.forEach(appendMessage);
    }
  }

  async function init() {
    if (!peerId || isNaN(peerId)) {
      alert('No conversation selected'); 
      location.href = 'index.html';
      return;
    }
    await loadMe();
    await loadPeer();
    await loadHistory();

    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const content = inputEl.value.trim();
      if (!content) return;

      const res = await fetch('/api/send-message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ toUserId: peerId, content })
      });
      if (res.ok) {
        inputEl.value = '';
        const saved = await res.json();
        appendMessage(saved);
      }
    });
  }

  init();
</script>
</body>
</html>
